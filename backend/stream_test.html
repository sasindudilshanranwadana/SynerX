<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SynerX Video Streaming</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1rem;
      }

      .content {
        padding: 30px;
      }

      .video-section {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 30px;
        margin-bottom: 30px;
      }

      .video-container {
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        min-height: 400px;
      }

      #videoCanvas {
        width: 100%;
        height: 100%;
        display: block;
      }

      .controls {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
      }

      .control-group {
        margin-bottom: 20px;
      }

      .control-group h3 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.2rem;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
        margin: 5px;
        width: 100%;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn.success {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
      }

      .btn.danger {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
      }

      .btn.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .status {
        background: #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .log-container {
        background: #2d3748;
        color: #e2e8f0;
        border-radius: 10px;
        padding: 20px;
        height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
      }

      .log-entry.info {
        color: #63b3ed;
      }
      .log-entry.success {
        color: #68d391;
      }
      .log-entry.error {
        color: #fc8181;
      }
      .log-entry.warning {
        color: #f6e05e;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .stat-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 5px;
      }

      @media (max-width: 768px) {
        .video-section {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸŽ¥ SynerX Video Streaming</h1>
        <p>Real-time vehicle detection and tracking</p>
      </div>

      <div class="content">
        <div class="video-section">
          <div class="video-container">
            <canvas id="videoCanvas"></canvas>
          </div>

          <div class="controls">
            <div class="control-group">
              <h3>ðŸ”— Connection</h3>
              <div id="connectionStatus" class="status disconnected">
                Disconnected
              </div>
              <button id="connectBtn" class="btn" onclick="connectToStream()">
                Connect to Stream
              </button>
            </div>

            <div class="control-group">
              <h3>ðŸŽ¬ Video Controls</h3>
              <button id="uploadBtn" class="btn" onclick="uploadVideo()">
                Upload Video
              </button>
              <button id="shutdownBtn" class="btn danger" onclick="shutdown()">
                Shutdown Processing
              </button>
            </div>

            <div class="stats">
              <div class="stat-card">
                <div id="fpsValue" class="stat-value">0</div>
                <div class="stat-label">FPS</div>
              </div>
              <div class="stat-card">
                <div id="frameValue" class="stat-value">0</div>
                <div class="stat-label">Frames</div>
              </div>
            </div>
          </div>
        </div>

        <div class="log-container" id="logContainer">
          <div class="log-entry info">
            ðŸš€ System ready. Click "Connect to Stream" to start.
          </div>
        </div>
      </div>
    </div>

    <script>
      let ws = null;
      let canvas = null;
      let ctx = null;
      let frameCount = 0;
      let lastFrameTime = 0;
      let fps = 0;

      // Initialize canvas
      function initCanvas() {
        canvas = document.getElementById("videoCanvas");
        ctx = canvas.getContext("2d");

        // Set canvas size
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
      }

      // Logging function
      function log(message, type = "info") {
        const logContainer = document.getElementById("logContainer");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;

        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;

        // Keep only last 100 entries
        while (logContainer.children.length > 100) {
          logContainer.removeChild(logContainer.firstChild);
        }
      }

      // Update connection status
      function updateConnectionStatus(connected) {
        const status = document.getElementById("connectionStatus");
        const connectBtn = document.getElementById("connectBtn");

        if (connected) {
          status.className = "status connected";
          status.textContent = "Connected";
          connectBtn.textContent = "Disconnect";
          connectBtn.onclick = disconnectFromStream;
        } else {
          status.className = "status disconnected";
          status.textContent = "Disconnected";
          connectBtn.textContent = "Connect to Stream";
          connectBtn.onclick = connectToStream;
        }
      }

      // Connect to WebSocket stream
      function connectToStream() {
        if (ws) {
          log("âŒ Already connected to stream", "error");
          return;
        }

        const clientId = "client_" + Math.random().toString(36).substr(2, 9);
        log("ðŸ”Œ Connecting to video stream...", "info");
        log(
          `ðŸ”— WebSocket URL: ws://localhost:8000/ws/video-stream/${clientId}`,
          "info"
        );

        ws = new WebSocket(`ws://localhost:8000/ws/video-stream/${clientId}`);

        ws.onopen = function () {
          log("âœ… WebSocket connection established", "success");
          updateConnectionStatus(true);

          // Send ping to keep connection alive
          setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send("ping");
            }
          }, 30000);
        };

        ws.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);

            if (data.type === "frame") {
              displayFrame(data.frame_data);
              updateStats(data.frame_number);
            } else if (data.type === "pong") {
              // Connection alive
            }
          } catch (error) {
            log(`âŒ Error parsing message: ${error}`, "error");
          }
        };

        ws.onclose = function () {
          log("ðŸ”Œ WebSocket connection closed", "warning");
          updateConnectionStatus(false);
          ws = null;
        };

        ws.onerror = function (error) {
          log(`âŒ WebSocket error: ${error}`, "error");
          updateConnectionStatus(false);
        };
      }

      // Disconnect from stream
      function disconnectFromStream() {
        if (ws) {
          ws.close();
          ws = null;
          log("ðŸ”Œ Disconnected from stream", "info");
        }
      }

      // Display video frame
      function displayFrame(frameData) {
        if (!canvas || !ctx) return;

        const img = new Image();
        img.onload = function () {
          // Clear canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Calculate aspect ratio
          const imgAspect = img.width / img.height;
          const canvasAspect = canvas.width / canvas.height;

          let drawWidth, drawHeight, offsetX, offsetY;

          if (imgAspect > canvasAspect) {
            drawWidth = canvas.width;
            drawHeight = canvas.width / imgAspect;
            offsetX = 0;
            offsetY = (canvas.height - drawHeight) / 2;
          } else {
            drawHeight = canvas.height;
            drawWidth = canvas.height * imgAspect;
            offsetX = (canvas.width - drawWidth) / 2;
            offsetY = 0;
          }

          ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
        };
        img.src = "data:image/jpeg;base64," + frameData;
      }

      // Update statistics
      function updateStats(frameNumber) {
        frameCount++;

        // Calculate FPS
        const now = performance.now();
        if (lastFrameTime > 0) {
          const delta = now - lastFrameTime;
          fps = 1000 / delta;
        }
        lastFrameTime = now;

        // Update display
        document.getElementById("fpsValue").textContent = fps.toFixed(1);
        document.getElementById("frameValue").textContent =
          frameNumber || frameCount;
      }

      // Upload video
      async function uploadVideo() {
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "video/*";
        fileInput.style.display = "none";

        fileInput.onchange = async function (e) {
          const file = e.target.files[0];
          if (!file) return;

          log(
            `ðŸ“¤ Uploading video: ${file.name} (${(
              file.size /
              1024 /
              1024
            ).toFixed(2)} MB)`,
            "info"
          );

          const formData = new FormData();
          formData.append("file", file);

          try {
            log("ðŸ“¤ Uploading video to server...", "info");

            const response = await fetch(
              "http://localhost:8000/upload-video/",
              {
                method: "POST",
                body: formData,
              }
            );

            if (!response.ok) {
              const errorText = await response.text();
              log(
                `âŒ Server error (${response.status}): ${errorText}`,
                "error"
              );
              return;
            }

            const result = await response.json();

            if (result.status === "done") {
              log("âœ… Video processing completed!", "success");
              log(
                `ðŸ“Š Stats: ${
                  result.processing_stats.total_vehicles
                } vehicles, ${result.processing_stats.compliance_rate.toFixed(
                  1
                )}% compliance`,
                "info"
              );
              if (result.processed_video_url) {
                log(
                  `ðŸŽ¥ Processed video: ${result.processed_video_url}`,
                  "info"
                );
              }
            } else {
              log(
                `âŒ Video processing failed: ${
                  result.error || "Unknown error"
                }`,
                "error"
              );
            }
          } catch (error) {
            log(`âŒ Upload failed: ${error.message}`, "error");
          }

          document.body.removeChild(fileInput);
        };

        document.body.appendChild(fileInput);
        fileInput.click();
      }

      // Test video processing
      async function testVideoProcessing() {
        try {
          log("ðŸ” Testing video processing setup...", "info");
          const response = await fetch(
            "http://localhost:8000/test-video-processing/"
          );

          if (!response.ok) {
            const errorText = await response.text();
            log(`âŒ Test failed (${response.status}): ${errorText}`, "error");
            return;
          }

          const result = await response.json();

          if (result.status === "success") {
            log("âœ… Video processing is ready!", "success");
            log(`ðŸ“ Model: ${result.model_path}`, "info");
            log(`ðŸŽ¥ Video: ${result.video_path}`, "info");
          } else if (result.status === "warning") {
            log(`âš ï¸ ${result.message}`, "warning");
            log(`â„¹ï¸ ${result.note}`, "info");
          } else {
            log(`âŒ ${result.error}`, "error");
          }
        } catch (error) {
          log(`âŒ Test failed: ${error.message}`, "error");
        }
      }

      // Start local processing
      async function startLocalProcessing() {
        try {
          log("ðŸš€ Starting local video processing...", "info");
          const response = await fetch(
            "http://localhost:8000/start-local-processing/",
            {
              method: "POST",
            }
          );

          const result = await response.json();

          if (result.status === "started") {
            log("âœ… Local processing started!", "success");
            log("ðŸ“º Check the video stream above", "info");
          } else {
            log(`âŒ Failed to start processing: ${result.error}`, "error");
          }
        } catch (error) {
          log(`âŒ Start processing failed: ${error.message}`, "error");
        }
      }

      // Shutdown processing
      async function shutdown() {
        try {
          log("ðŸ›‘ Requesting shutdown...", "info");
          const response = await fetch("http://localhost:8000/shutdown/", {
            method: "POST",
          });

          const result = await response.json();

          if (result.status === "shutdown_requested") {
            log("âœ… Shutdown requested successfully", "success");
            log(
              `â±ï¸ Processing time: ${result.processing_time.toFixed(2)}s`,
              "info"
            );
          } else {
            log(`âŒ Shutdown failed: ${result.error}`, "error");
          }
        } catch (error) {
          log(`âŒ Shutdown request failed: ${error.message}`, "error");
        }
      }

      // Initialize on page load
      window.onload = function () {
        initCanvas();
        log("ðŸš€ System initialized. Auto-connecting to stream...", "info");
        // Auto-connect to stream
        setTimeout(() => {
          connectToStream();
        }, 1000); // Small delay to ensure everything is ready
      };

      // Handle window resize
      window.addEventListener("resize", function () {
        initCanvas();
      });
    </script>
  </body>
</html>
